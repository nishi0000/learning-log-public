# 実装ログ（事実ログ）— AWS × C#（.NET 8）× Vue：`POST /logs` ルート追加〜DTOデシリアライズ作業、Git操作（秘匿情報マスク版）

更新日時: 2026-01-14 +0900（会話日時ベース）

---

## 1. 作業目的

- API Gateway に `POST /logs` ルートを追加し、既存Lambdaへ到達することを確認する
    
- `/logs` への POST で `request.Body` が Lambda に届くことを確認する
    
- Bodyなし/JSON不正時に 400 応答が返ることを確認する
    
- `/logs` 用DTO（`LogsRequest`）の追加と、デシリアライズ実装の下準備を行う
    
- Gitのコミット・push を行い、リモートブランチに反映されることを確認する
    

---

## 2. 作業対象（環境）

- API: API Gateway（HTTP API） + AWS Lambda（C# / .NET 8）
    
- API名: `todo-api-http`
    
- Lambda関数名: `todo-api`
    
- 既存ルート: `/todos`（GET/POST）
    
- 追加ルート: `/logs`（POST）
    
- 検証: PowerShell（`curl.exe`）
    
- ログ確認: CloudWatch Logs
    

---

## 3. 実施内容と結果

### 3.1 API Gateway に `POST /logs` ルート追加

**何をした**

- API Gateway コンソール → Routes 画面で「作成」
    
- ルート `POST /logs` を追加
    
- 既存の `/todos` と同じ Lambda（`todo-api`）へ統合（Integration）するよう設定
    

**何が起きた**

- 画面上部に「ルート POST /logs が正常に created」表示
    
- Routes 一覧に `/logs` → `POST` が追加された
    

**現在どうなっている**

- API Gateway に `POST /logs` ルートが存在し、Lambda（`todo-api`）へ統合されている
    

---

### 3.2 Integration（統合）の確認

**何をした**

- Integrations 画面で `POST /logs` の統合詳細を確認
    
- `Lambda 関数: todo-api (ap-northeast-1)` であることを確認
    

**何が起きた**

- `GET /todos` / `POST /todos` と `POST /logs` で「統合ID」が異なる表示だった
    

**現在どうなっている**

- 統合IDは異なるが、`POST /logs` は同じLambda（`todo-api`）に到達する設定で確定
    

---

### 3.3 デプロイ関連（オートデプロイ）

**何をした**

- 右上「デプロイ」操作を実行しようとした
    

**何が起きた**

- 「オートデプロイを有効にしました」の表示が出た
    

**現在どうなっている**

- ステージ反映はオートデプロイ設定が有効な状態
    

---

### 3.4 `POST /logs` 到達確認（Bodyなし）

**何をした**

- PowerShellで `POST /logs` を Bodyなしで実行
    

**実行コマンド（URLマスク）**

```powershell
$url = "{API_BASE_URL}/prod/logs"
curl.exe -i -X POST -H "Content-Type: application/json" $url
```

**何が起きた**

- 応答: `HTTP/1.1 400 Bad Request`
    
- Body: `{"error":"empty body"}`
    

**現在どうなっている**

- `POST /logs` が API Gateway → Lambda まで到達し、Body空判定で 400/JSON本文を返せる状態を確認済み
    

---

### 3.5 `POST /logs` 到達確認（Bodyあり、logs形式）

**何をした**

- PowerShellで logs形式のJSONをBodyに付けて `POST /logs` を実行
    

**実行コマンド（URL/Bodyマスク）**

```powershell
curl.exe -i -X POST -H "Content-Type: application/json" -d "{...}" $url
```

**何が起きた**

- curl 側の警告:
    
    - `curl: (3) URL rejected: Port number was not a decimal number between 0 and 65535`
        
    - `curl: (3) URL rejected: Bad hostname`
        
- API応答:
    
    - `HTTP/1.1 400 Bad Request`
        
    - Body: `{"error":"invalid json"}`
        

**現在どうなっている**

- `/logs` ルートはLambdaに到達しているが、Lambda側は todo用DTOでDeserializeしており、logs形式のJSONでは `invalid json` になる状態を確認
    

---

### 3.6 Lambdaコード修正（LogsRequest DTO追加・Deserialize実装の試行）

**何をした**

- `Function.cs` に `/logs` 用DTOを追加
    
- `request.RawPath` を `path` として取り出し、ログ出力
    
- `POST` 時の `Body` 空チェック（`string.IsNullOrWhiteSpace(body)`）を継続
    
- `/logs` と `/todos` でDTOを切り替えてDeserializeする実装を試行
    
- Deserialize戻り値の代入、変数スコープ（ifブロック内宣言）を調整
    

**変更したコード断片（例）**

- DTO追加:
    
    - `public record LogsRequest(DateTime ts, string type, string text);`
        
- パス取得:
    
    - `var path = request?.RawPath;`
        
- Deserialize（戻り値を dto に代入する形に修正）:
    
    - `dto = JsonSerializer.Deserialize<LogsRequest>(request.Body);`
        

**何が起きた**

- `/logs` と `/todos` を同一の `dto` 変数で扱おうとした箇所で、スコープ/型の不整合が発生する状態になった
    
- Deserialize の戻り値を変数に代入していない場合、`dto` が `null` のままになる状態になった
    

**現在どうなっている**

- `LogsRequest` DTO追加と、`dto = JsonSerializer.Deserialize<LogsRequest>(request.Body);` の代入まで実装したブランチが存在する
    
- 返却JSON（echo）は todo用（`title/completed`）のままのため、`LogsRequest` に合わせたレスポンス（`ts/type/text`）へ変更が必要な状態
    

---

## 4. Git操作（コミット・push）

### 4.1 コミット

**何をした**

- 変更をステージングしてコミット
    

**コマンド**

```bash
git add .
git commit -m "Add POST /logs DTO and deserialize"
```

---

### 4.2 push（リモートブランチ反映）

**何をした**

- 作業ブランチを push
    

**結果ログ（抜粋）**

- `feat/3-post-logs-echo -> feat/3-post-logs-echo`
    

**状態確認コマンドと出力**

```bash
git status -sb
# ## feat/3-post-logs-echo...origin/feat/3-post-logs-echo

git branch --show-current
# feat/3-post-logs-echo

git log -1 --oneline
# dc82b49 (HEAD -> feat/3-post-logs-echo, origin/feat/3-post-logs-echo) Add POST /logs DTO and deserialize
```

**現在どうなっている**

- ローカルブランチ `feat/3-post-logs-echo` と `origin/feat/3-post-logs-echo` が同一コミットを指している状態で確定（push済み）
    

---

## 5. 最終状態（確定）

- API Gateway に `POST /logs` ルートが追加され、Lambda（`todo-api`）へ統合されている
    
- `POST /logs`（Bodyなし）で `HTTP 400` / `{"error":"empty body"}` が返り、到達と分岐が確認できている
    
- `POST /logs`（logs形式JSON）で `HTTP 400` / `{"error":"invalid json"}` が返り、現状のDeserialize対象が todo用であることが確認できている
    
- Lambda側に `LogsRequest` DTOを追加し、`dto = JsonSerializer.Deserialize<LogsRequest>(request.Body);` の代入まで実装したコミットが存在する
    
- Git ブランチ `feat/3-post-logs-echo` をコミット・push 済みで、`origin/feat/3-post-logs-echo` と同期されている
    

---