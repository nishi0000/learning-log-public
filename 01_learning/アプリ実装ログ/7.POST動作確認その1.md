# 実装ログ（事実ログ）— AWS × C#（.NET 8）× Vue：/todos POST受信確認 & GitHub Issue運用

更新日時: 2026-01-12 +0900

---

## 1. 作業目的

- `/todos` に対して **POST が API Gateway → Lambda に届く**ことを確認する
    
- **request.Body（JSON）を受け取れる**ことを確認する
    
- JSON不正／Bodyなしのケースで **400 を返す**ことを確認する
    
- GitHubで **Issue → ブランチ → PR → マージ → Issueクローズ → ブランチ削除** の一連を実施する
    

---

## 2. 作業対象（環境）

- API: API Gateway（HTTP API） + AWS Lambda（C# / .NET 8）
    
- エンドポイント:
    
    - `https://zkn04f1al1.execute-api.ap-northeast-1.amazonaws.com/prod/todos`
        
- クライアント検証: PowerShell（Invoke-RestMethod / Invoke-WebRequest）、curl.exe
    
- ログ確認: CloudWatch Logs
    

---

## 3. 実施内容と結果

### 3.1 Lambdaの入出力型（HTTP API v2）を統一

**何をした**

- Lambdaハンドラのシグネチャを v2 に統一
    
    - 引数: `APIGatewayHttpApiV2ProxyRequest`
        
    - 戻り値: `APIGatewayHttpApiV2ProxyResponse`
        
- 返却型が `APIGatewayProxyResponse`（v1）と混在していた箇所を修正
    

**何が起きた**

- GET/POSTのどちらも同じレスポンス型で返せる形に整理された
    

**現在どうなっている**

- `FunctionHandler(APIGatewayHttpApiV2ProxyRequest, ILambdaContext)` が `APIGatewayHttpApiV2ProxyResponse` を返す構成で確定
    

---

### 3.2 POST分岐の確認（固定レスポンス → request.Bodyの受信確認）

**何をした**

- `request.RequestContext.Http.Method` により POST/GET を分岐
    
- POST時に `request.Body` の内容を CloudWatch にログ出力（先頭・長さなど）
    

**何が起きた**

- CloudWatch Logs に `bodyLen=...` や `body='...'` が出力され、POSTで送ったJSONがLambdaに届いていることを確認
    

**現在どうなっている**

- POSTで request.Body を取得できることをCloudWatchログで確認済み
    

---

### 3.3 JSONをDTOにデシリアライズしてecho（POSTの入力値をレスポンスへ反映）

**何をした**

- DTOを追加
    
    - `public record TodoCreateRequest(string title, bool completed);`
        
- POST時に `JsonSerializer.Deserialize<TodoCreateRequest>(body)` を実行
    
- デシリアライズした `dto.title / dto.completed` をレスポンスに含めて返す（echo）
    

**何が起きた**

- PowerShellで異なる値をPOSTしても、レスポンスに同じ値が返ることを確認（echo成功）
    

**現在どうなっている**

- POST body の JSON をDTOとして扱い、レスポンスに反映できる状態で確定
    

---

### 3.4 例外・入力不正のハンドリング（400/500）

**何をした**

- Bodyなし／空を事前判定（Deserialize前にチェック）
    
- JSON不正を `JsonException` で捕捉して400を返す
    
- 想定外例外は500を返す
    

**ハンドリング方針（実装）**

- `string.IsNullOrWhiteSpace(body)` → 400 `{"error":"empty body"}`
    
- `catch (JsonException)` → 400 `{"error":"invalid json"}`
    
- `catch (Exception)` → 500 `{"error":"internal error"}`
    
- `dto == null` → 400（現状は `empty body` を返す）
    

**何が起きた**

- BodyなしPOSTで400が返ることを確認
    
- PowerShellの `Invoke-WebRequest` では一部環境でエラー本文が取りづらかった
    
- `curl.exe -i -X POST ...` で 400 と `{"error":"empty body"}` が返ることを確認（API側が本文を返していることを確定）
    

**現在どうなっている**

- Bodyなし／JSON不正／想定外例外のレスポンスが分岐し、HTTPステータスとJSON本文を返す状態で確定
    

---

## 4. 検証コマンド（実行した内容）

### 4.1 PowerShell（POST with JSON body）

```powershell
$url = "https://zkn04f1al1.execute-api.ap-northeast-1.amazonaws.com/prod/todos"
$body = @{ title = "from ps"; completed = $false } | ConvertTo-Json
Invoke-RestMethod -Uri $url -Method Post -Body $body -ContentType "application/json" -Verbose
```

### 4.2 BodyなしPOST（curl.exeで本文確認）

```powershell
curl.exe -i -X POST -H "Content-Type: application/json" $url
```

---

## 5. GitHub運用（Issue → PR → Merge → Close → Branch delete）

**何をした**

- GitHub上で Issue を作成
    
- 作業ブランチを作成し、実装をコミット
    
- ブランチをpush
    
- Pull Requestを作成し、本文に `Closes #1` を記載
    
- PRをmainへマージ
    
- Issueが自動でクローズされたことを確認
    
- GitHub上の作業ブランチを削除（Delete branch）
    
- ローカルで main へ戻し `pull`、ローカル作業ブランチを削除
    

**何が起きた**

- PRマージと同時に Issue #1 がクローズ
    
- PR番号とIssue番号が同一の通し番号体系であることを確認（例：PRが #2、次のIssueが #3 になり得る）
    

**現在どうなっている**

- main に変更が取り込まれ、リモート作業ブランチは削除済み
    
- ローカルも main 同期・作業ブランチ削除まで完了
    

---

## 6. 最終状態（確定）

- `/prod/todos` で以下が成立
    
    - GET: 配列JSONを返す
        
    - POST: request.Body（JSON）をDTOにDeserializeして、入力値をレスポンスに反映して返す（echo）
        
    - Bodyなし: 400 + `{"error":"empty body"}`
        
    - JSON不正: 400 + `{"error":"invalid json"}`
        
    - 想定外: 500 + `{"error":"internal error"}`
        
- GitHubで Issue駆動の作業フロー（Issue→ブランチ→PR→マージ→Issueクローズ→ブランチ削除）を1周完了