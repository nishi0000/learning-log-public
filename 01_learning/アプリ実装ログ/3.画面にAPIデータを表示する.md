
# 実装ログ

（Vue → API Gateway → Lambda / C# 一気通貫確認）

## 1. この時やりたかったこと

- Vue → API Gateway → Lambda（C#）を **一気通貫で動かす**
    
- まずは最低限：
    
    - API が JSON を返す
        
    - Vue から取得できる
        
    - 画面に 1 項目表示できる  
        ところまで確認する
        

「アプリ制作」ではなく、  
**通信・状態・描画がちゃんとつながっているかの実感を得る**のが目的。

---

## 2. 最初にできていたこと（前提）

### バックエンド側

- Lambda（C# / .NET 8）
    
    - `APIGatewayProxyRequest` → `APIGatewayProxyResponse`
        
    - `Body` に JSON 文字列を入れて返却
        
- API Gateway（HTTP API）
    
    - `GET /todos`
        
    - ブラウザ直叩きでは JSON が返ることを確認済み
        

```json
{"id":1,"title":"sample todo","completed":false}
```

👉 **API 単体では動いていた**

---

## 3. Vue 側で最初にやったこと

- Vite + Vue3 の初期テンプレート
    
- `<script setup>` に `fetch()` を書いて console.log
    

```js
onMounted(async () => {
  const res = await fetch(url)
  const data = await res.json()
  console.log(data)
})
```

---

## 4. 最初につまずいたポイント①

### 「fetch が失敗する（ように見える）」

### 実際に起きたエラー

```
has been blocked by CORS policy:
No 'Access-Control-Allow-Origin' header is present
```

### そのときの認識

- fetch の書き方が悪い？
    
- Vue の設定？
    
- Lambda のレスポンスが変？
    

### 実際の原因

- **API Gateway 側で CORS 未設定**
    
- ブラウザは
    
    - `localhost:5173`
        
    - `execute-api.amazonaws.com`  
        の **オリジン差**を厳密に見る
        

👉 API が動いていても、  
**ブラウザから呼べるとは限らない**

### 修正

- API Gateway（HTTP API）で CORS 設定
    
    - Allow Origin: `http://localhost:5173`
        
- ステージ（prod）を再デプロイ
    

👉 **Vue 側は一切修正不要**

---

## 5. つまずいたポイント②

### 「console.log は出るのに、画面に出ない」

### やりたかったこと

- API の戻り値を template に表示
    
- `todo.title` を出したい
    

### 書いたコード（当初）

```js
const todo = ref(null)

onMounted(async () => {
  const res = await fetch(...)
  const data = await res.json()
  todo.value = await res.json()
})
```

---

### 原因①：`ref` の import 忘れ

```js
import { onMounted } from 'vue'
// ref を import していなかった
```

👉 **そもそもリアクティブになっていなかった**

---

### 原因②：`res.json()` を 2 回呼んでいた

```js
const data = await res.json()
todo.value = await res.json() // ← ここ
```

そのときは、

- 「関数を2回呼んだだけ」
    
- 「await だから非同期的にまた取れる？」
    

と思っていた。

---

## 6. `res.json()` が 1 回しか読めない理由

### 最初の勘違い

- `res` の中に JSON データが入っている
    
- `res.json()` は「取り出す関数」
    

### 実際の正体

- `res` は **HTTPレスポンス全体のオブジェクト**
    
- 本体データは `res.body`
    
- `body` は **ストリーム**
    

```text
API
 ↓
データが流れてくる
 ↓
res.body（ストリーム）
```

### `res.json()` がやっていること

- ストリームを **最初から最後まで読み切る**
    
- 文字列にまとめる
    
- JSON としてパースする
    

👉 **「読む」操作**

---

### なぜ 2 回目がダメなのか

- ストリームは
    
    - 読むと流れて消える
        
    - 保存されていない
        

イメージとしては：

- Spotify（何度でも再生） ❌
    
- **生放送のラジオ** ✅
    

`res.json()` は  
**「今流れている放送を最初から最後まで聞く」**

一度聞き切ったら、  
**同じ放送はもう流れてこない**

---

### 正しい使い方

```js
const data = await res.json() // ここで一回だけ読む
todo.value = data            // あとは使い回す
```

---

## 7. ref / const で混乱した点の整理

### 疑問

- `const` なのに値を変えていい？
    
- `ref(null)` の `null` は型？
    

### 実際の理解

- `const` が固定しているのは **参照（アドレス）**
    
- `ref` は **中身が変わる箱**
    
- `.value` が箱の中身
    
- `ref(null)` の `null` は **初期値**
    

```js
const todo = ref(null)   // 箱は固定
todo.value = data        // 中身を入れ替える
```

Vue は  
**箱（ref オブジェクト）を監視している**

---

## 8. 最終的に確認できた状態

- Vue 起動
    
- onMounted で API 呼び出し
    
- CORS を越えてレスポンス取得
    
- `ref` に代入
    
- **画面に `sample todo` が表示される**
    

```vue
<p>{{ todo?.title }}</p>
```

👉 **Vue → API Gateway → Lambda → JSON → 画面**  
一気通貫で確認完了。

---

## 9. この時点で腹落ちしたこと（重要）

- CORS は **ブラウザ特有の制約**
    
- API が動く ≠ ブラウザから取れる
    
- `ref` は「変わる値を Vue に知らせる箱」
    
- `const` は参照固定のために使う
    
- `res.json()` は「取得」ではなく **「一度きりの読み取り」**
    

---

## 10. 区切り

- todo を配列にする
    
- POST を試す
    
- 構成整理（App.vue / Home.vue）
    
